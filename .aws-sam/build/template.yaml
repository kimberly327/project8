AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'project8

  Sample SAM Template for project8

  '
Resources:
  StockTradingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: ../../statemachine/stock_trader.asl.json
      DefinitionSubstitutions:
        StockCheckerFunctionArn:
          Fn::GetAtt:
          - StockCheckerFunction
          - Arn
        StockSellerFunctionArn:
          Fn::GetAtt:
          - StockSellerFunction
          - Arn
        StockBuyerFunctionArn:
          Fn::GetAtt:
          - StockBuyerFunction
          - Arn
        CancelOperationFunctionArn:
          Fn::GetAtt:
          - CancelTransactionFunction
          - Arn
        DDBPutItem:
          Fn::Sub: arn:${AWS::Partition}:states:::dynamodb:putItem
        DDBTable:
          Ref: TransactionTable
      Events:
        HourlyTradingSchedule:
          Type: Schedule
          Properties:
            Description: Schedule to run the stock trading state machine every hour
            Enabled: false
            Schedule: rate(1 hour)
      Policies:
      - LambdaInvokePolicy:
          FunctionName:
            Ref: StockCheckerFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: StockSellerFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: StockBuyerFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: CancelOperationFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: CancelTransactionFunction
      - DynamoDBWritePolicy:
          TableName:
            Ref: TransactionTable
  StockCheckerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: StockCheckerFunction
      Handler: app.lambdaHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
    Metadata:
      SamResourceId: StockCheckerFunction
  StockSellerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: StockSellerFunction
      Handler: app.lambdaHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
    Metadata:
      SamResourceId: StockSellerFunction
  StockBuyerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: StockBuyerFunction
      Handler: app.lambdaHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
    Metadata:
      SamResourceId: StockBuyerFunction
  CancelOperationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CancelOperationFunction
      Handler: app.lambdaHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
    Metadata:
      SamResourceId: CancelOperationFunction
  CancelTransactionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CancelTransactionFunction
      Handler: app.lambdaHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
    Metadata:
      SamResourceId: CancelTransactionFunction
  TransactionTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: Id
        Type: String
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Join:
        - ''
        - - ApplicationInsights-SAM-
          - Ref: AWS::StackName
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Fn::Join:
        - ''
        - - ApplicationInsights-SAM-
          - Ref: AWS::StackName
      AutoConfigurationEnabled: 'true'
    DependsOn: ApplicationResourceGroup
Outputs:
  StockTradingStateMachineArn:
    Description: Stock Trading state machine ARN
    Value:
      Ref: StockTradingStateMachine
  StockTradingStateMachineRole:
    Description: IAM Role created for Stock Trading state machine based on the specified
      SAM Policy Templates
    Value:
      Fn::GetAtt:
      - StockTradingStateMachineRole
      - Arn
